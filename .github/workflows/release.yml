name: Build and Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number (e.g., 1.0.0)'
        required: true
        type: string
  push:
    tags:
      - 'v*.*.*'

permissions:
  contents: write

env:
  NODE_VERSION: '20'

jobs:
  # ============================================================================
  # macOS Apple Silicon (M1/M2/M3)
  # ============================================================================
  build-macos-arm64:
    name: Build macOS (Apple Silicon)
    runs-on: macos-14
    env:
      HAS_SIGNING_CERT: ${{ secrets.MACOS_CERTIFICATE != '' }}
      HAS_NOTARIZE_CREDS: ${{ secrets.NOTARIZE_APPLE_ID != '' }}

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            daemon-ts/package-lock.json

      - name: Get Electron version
        id: electron-version
        run: echo "version=$(node -p "require('./package.json').devDependencies.electron")" >> $GITHUB_OUTPUT

      - name: Cache Electron binary
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/electron
          key: electron-macos-${{ steps.electron-version.outputs.version }}

      - name: Cache electron-builder
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/electron-builder
          key: electron-builder-macos-${{ hashFiles('electron-builder.json') }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~/Library/Caches/pip
          key: pip-macos-boto3

      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update version in package.json
        run: |
          sed -i.bak "s/\"version\": \"[^\"]*\"/\"version\": \"${{ steps.version.outputs.version }}\"/" package.json
          rm package.json.bak
          echo "Updated version to ${{ steps.version.outputs.version }}"

      - name: Install npm dependencies
        run: |
          npm ci
          cd daemon-ts
          npm ci

      - name: Import Code-Signing Certificates
        if: env.HAS_SIGNING_CERT == 'true'
        uses: Apple-Actions/import-codesign-certs@v2
        with:
          p12-file-base64: ${{ secrets.MACOS_CERTIFICATE }}
          p12-password: ${{ secrets.MACOS_CERTIFICATE_PWD }}

      - name: Build application
        run: |
          if [ "$HAS_SIGNING_CERT" = "true" ]; then
            echo "Building with code signing..."
            export CODESIGN_IDENTITY="${{ secrets.MACOS_SIGNING_IDENTITY }}"
            ./scripts/build_app_macos.sh
          else
            echo "Building without code signing..."
            ./scripts/build_app_macos.sh --no-sign
          fi
        env:
          MACOSX_DEPLOYMENT_TARGET: '11.0'

      - name: Notarize DMG
        if: env.HAS_NOTARIZE_CREDS == 'true'
        run: |
          echo "Storing notarization credentials..."
          xcrun notarytool store-credentials "notarytool-profile" \
            --apple-id "${{ secrets.NOTARIZE_APPLE_ID }}" \
            --team-id "${{ secrets.APPLE_TEAM_ID }}" \
            --password "${{ secrets.NOTARIZE_APP_PWD }}"

          echo "Submitting DMG for notarization..."
          xcrun notarytool submit dist/Ami-${{ steps.version.outputs.version }}.dmg \
            --keychain-profile "notarytool-profile" \
            --wait

          echo "Stapling notarization ticket..."
          xcrun stapler staple dist/Ami-${{ steps.version.outputs.version }}.dmg

          echo "âœ“ Notarization complete"

      - name: Rename DMG
        run: |
          cd dist
          mv Ami-${{ steps.version.outputs.version }}.dmg Ami-${{ steps.version.outputs.version }}-macos-arm64.dmg
          ls -lh *.dmg

      - name: Install boto3 for R2
        run: pip3 install --break-system-packages boto3

      - name: Upload to Cloudflare R2
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          SIGNED="false"
          NOTARIZED="false"

          if [ -n "${{ secrets.MACOS_CERTIFICATE }}" ]; then
            SIGNED="true"
          fi

          if [ -n "${{ secrets.NOTARIZE_APPLE_ID }}" ]; then
            NOTARIZED="true"
          fi

          python3 .github/scripts/upload_to_r2.py \
            --file "dist/Ami-${{ steps.version.outputs.version }}-macos-arm64.dmg" \
            --version "${{ steps.version.outputs.version }}" \
            --platform macos \
            --arch arm64 \
            --commit-sha "${{ github.sha }}" \
            $([ "$SIGNED" = "true" ] && echo "--signed") \
            $([ "$NOTARIZED" = "true" ] && echo "--notarized")

  # ============================================================================
  # macOS Intel (x86_64) - DISABLED: macos-13 runner retired by GitHub
  # Note: macOS on Apple Silicon can run x64 apps via Rosetta 2
  # Universal binary support can be added later if needed
  # See: https://github.com/actions/runner-images/issues/13046
  # ============================================================================

  # ============================================================================
  # Windows x64
  # ============================================================================
  build-windows:
    name: Build Windows (x64)
    runs-on: blacksmith-4vcpu-windows-2025

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'
          cache-dependency-path: |
            package-lock.json
            daemon-ts/package-lock.json

      - name: Get Electron version
        id: electron-version
        shell: bash
        run: echo "version=$(node -p "require('./package.json').devDependencies.electron")" >> $GITHUB_OUTPUT

      - name: Cache Electron binary
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\electron\Cache
          key: electron-windows-${{ steps.electron-version.outputs.version }}

      - name: Cache electron-builder
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\electron-builder\Cache
          key: electron-builder-windows-${{ hashFiles('electron-builder.json') }}

      - name: Cache pip packages
        uses: actions/cache@v4
        with:
          path: ~\AppData\Local\pip\Cache
          key: pip-windows-boto3

      - name: Get version
        id: version
        shell: bash
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Update version in package.json
        shell: bash
        run: |
          sed -i "s/\"version\": \"[^\"]*\"/\"version\": \"${{ steps.version.outputs.version }}\"/" package.json

      - name: Install npm dependencies
        run: |
          npm ci
          cd daemon-ts
          npm ci

      - name: Build Windows application
        shell: pwsh
        run: |
          .\scripts\build_app_windows.ps1

      - name: Rename ZIP
        shell: bash
        run: |
          cd portable
          mv AmiPortable.zip Ami-${{ steps.version.outputs.version }}-windows-x64.zip
          ls -lh *.zip

      - name: Install boto3 for R2
        shell: bash
        run: pip install boto3

      - name: Upload to Cloudflare R2
        shell: bash
        env:
          R2_ACCESS_KEY_ID: ${{ secrets.R2_ACCESS_KEY_ID }}
          R2_SECRET_ACCESS_KEY: ${{ secrets.R2_SECRET_ACCESS_KEY }}
          R2_ENDPOINT: ${{ secrets.R2_ENDPOINT }}
          R2_BUCKET: ${{ secrets.R2_BUCKET }}
        run: |
          python .github/scripts/upload_to_r2.py \
            --file "portable/Ami-${{ steps.version.outputs.version }}-windows-x64.zip" \
            --version "${{ steps.version.outputs.version }}" \
            --platform windows \
            --arch x64 \
            --commit-sha "${{ github.sha }}"

  # ============================================================================
  # Create GitHub Release (only on tag push)
  # ============================================================================
  create-release:
    name: Create GitHub Release
    needs: [build-macos-arm64, build-windows]
    runs-on: blacksmith-4vcpu-ubuntu-2404
    if: startsWith(github.ref, 'refs/tags/v') || github.event_name == 'workflow_dispatch'

    steps:
      - name: Get version
        id: version
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "version=${{ github.event.inputs.version }}" >> $GITHUB_OUTPUT
          else
            echo "version=${GITHUB_REF#refs/tags/v}" >> $GITHUB_OUTPUT
          fi

      - name: Create Release
        uses: softprops/action-gh-release@v1
        with:
          name: Ami v${{ steps.version.outputs.version }}
          draft: false
          prerelease: false
          generate_release_notes: true
          body: |
            ## Downloads

            | Platform | Architecture | Download |
            |----------|--------------|----------|
            | macOS | Apple Silicon (M1/M2/M3) | [Ami-${{ steps.version.outputs.version }}-macos-arm64.dmg](${{ secrets.R2_PUBLIC_URL }}/releases/v${{ steps.version.outputs.version }}/macos-arm64/Ami-${{ steps.version.outputs.version }}-macos-arm64.dmg) |
            | Windows | x64 | [Ami-${{ steps.version.outputs.version }}-windows-x64.zip](${{ secrets.R2_PUBLIC_URL }}/releases/v${{ steps.version.outputs.version }}/windows-x64/Ami-${{ steps.version.outputs.version }}-windows-x64.zip) |
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
